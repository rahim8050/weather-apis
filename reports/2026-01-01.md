# DRF Report (Weather APIs) — 2026-01-01 (EAT)

## Done
- HMAC request signing flow exists on the DRF side (timestamp + nonce + signature), with “handshake” endpoints in the flow (token / whoami / ping).
- Integration JWT minting updated: sets/normalizes `sub` and `user_id`, and auth accepts legacy `user_id`-only tokens.
- `whoami` claim lookup hardened (uses safe `.get()` access to avoid crashes).
- Integration token tests updated + backward-compat test added (passes per latest run).

## In progress
- Aligning DRF config expectations with what Nextcloud saves (canonical keys vs legacy keys).
- Hardening runtime parsing of HMAC clients config (prevent `JSONDecodeError` from invalid/empty env JSON).
- Re-running smoke tests (token → whoami) without env-var gaps (e.g., missing `WHOAMI_PATH`).

## Next
- Make DRF settings parsing **non-crashing + fail-closed**:
  - If HMAC clients JSON is empty/invalid: log warning, treat as “no clients configured”, return 403 on signed endpoints (instead of crashing).
- Confirm canonical `clientId` matches Nextcloud exactly (`nextcloud`) and DRF lookup uses the same.
- Run full quality gate:
  - `ruff check . && ruff format .`
  - `mypy .`
  - `bandit -c pyproject.toml -r .`
  - `pytest`
- Capture an end-to-end smoke run (token + whoami) with logs.

## Blockers / Risks
- **Config mismatch:** Nextcloud mixed keys (`api_key` vs `apiKey`, `hmac_secret` vs `signingSecret/hmacSecret`) can cause DRF auth failures even if HMAC is correct.
- **Startup crash risk:** invalid/empty JSON env config can crash DRF unless guarded.
- **Test false negatives:** missing exported env vars (e.g., `WHOAMI_PATH`) breaks smoke scripts.

## Verification Commands
- Boot:
  - `python manage.py runserver 127.0.0.1:8001`
- Smoke script (placeholders; don’t paste secrets into logs):
  - `export BASE_URL=http://127.0.0.1:8001`
  - `export CLIENT_ID=nextcloud`
  - `export API_KEY='wk_live_...'`
  - `export HMAC_SECRET='plaintext-secret'`
  - `bash tools/nc_smoke.sh`
- Curl ping sanity:
  - `curl -sS "$BASE_URL/api/v1/integrations/nextcloud/ping/" -D- | head`
# DRF Report (Weather APIs) — 2026-01-01 (EAT)

## Done
- HMAC request signing flow exists on the DRF side (timestamp + nonce + signature), with “handshake” endpoints in the flow (token / whoami / ping).
- Integration JWT minting updated: sets/normalizes `sub` and `user_id`, and auth accepts legacy `user_id`-only tokens.
- `whoami` claim lookup hardened (uses safe `.get()` access to avoid crashes).
- Integration token tests updated + backward-compat test added (passes per latest run).

## In progress
- Aligning DRF config expectations with what Nextcloud saves (canonical keys vs legacy keys).
- Hardening runtime parsing of HMAC clients config (prevent `JSONDecodeError` from invalid/empty env JSON).
- Re-running smoke tests (token → whoami) without env-var gaps (e.g., missing `WHOAMI_PATH`).

## Next
- Make DRF settings parsing **non-crashing + fail-closed**:
  - If HMAC clients JSON is empty/invalid: log warning, treat as “no clients configured”, return 403 on signed endpoints (instead of crashing).
- Confirm canonical `clientId` matches Nextcloud exactly (`nextcloud`) and DRF lookup uses the same.
- Run full quality gate:
  - `ruff check . && ruff format .`
  - `mypy .`
  - `bandit -c pyproject.toml -r .`
  - `pytest`
- Capture an end-to-end smoke run (token + whoami) with logs.

## Blockers / Risks
- **Config mismatch:** Nextcloud mixed keys (`api_key` vs `apiKey`, `hmac_secret` vs `signingSecret/hmacSecret`) can cause DRF auth failures even if HMAC is correct.
- **Startup crash risk:** invalid/empty JSON env config can crash DRF unless guarded.
- **Test false negatives:** missing exported env vars (e.g., `WHOAMI_PATH`) breaks smoke scripts.

## Verification Commands
- Boot:
  - `python manage.py runserver 127.0.0.1:8001`
- Smoke script (placeholders; don’t paste secrets into logs):
  - `export BASE_URL=http://127.0.0.1:8001`
  - `export CLIENT_ID=nextcloud`
  - `export API_KEY='wk_live_...'`
  - `export HMAC_SECRET='plaintext-secret'`
  - `bash tools/nc_smoke.sh`
- Curl ping sanity:
  - `curl -sS "$BASE_URL/api/v1/integrations/nextcloud/ping/" -D- | head`

