# DRF — Progress Note (2025-12-31)

## Done
- Updated integration JWT minting to set `sub` / `user_id` from the API key’s user, and kept `scope` populated with a safe fallback.
- Updated auth to accept legacy tokens (`user_id`-only) and normalized `sub` to string.
- Made whoami claim lookup safer by using `.get()` before indexing.
- Tests updated + passing:
  - `integrations/tests/test_integration_token.py` (minted-claims assertions + backward-compat acceptance test).
  - Noted deprecation warning about DRF format suffix converter (Django 6.0).

## In progress
- End-to-end validation of HMAC flow against `whoami` (calling whoami with HMAC).
- Environment config hardening for missing/invalid variables.

## Next
- Run full hygiene + verification sweep:
  - `ruff check .` and `ruff format .`
  - `mypy .`
  - `bandit -c pyproject.toml -r .`
  - `pytest`
  - `python manage.py runserver` + smoke-test endpoints
- Fix config pitfalls:
  - Ensure `WHOAMI_PATH` is defined (or provide a safe default).
  - Fix JSON parsing for Nextcloud HMAC clients config (ensure valid JSON string in env).

## Blockers
- `KeyError: 'WHOAMI_PATH'` (missing env/config).
- `JSONDecodeError` when parsing `_nextcloud_hmac_clients_raw` (env JSON empty/invalid).

## Links / Evidence
- Codex report: JWT minting + auth back-compat + whoami claim safety; tests passing for `integrations/tests/test_integration_token.py`.
- Terminal errors captured:
  - `KeyError: 'WHOAMI_PATH'`
  - `JSONDecodeError` in `config/settings.py` during JSON load.

